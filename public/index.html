<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Tangram</title>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/caiuss/1.0.2/caiuss.min.css" type="text/css" media="screen" charset="utf-8">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.css" type="text/css" media="screen" charset="utf-8"> -->
    <link
      rel="stylesheet"
      href="css/style.css"
      type="text/css"
      media="screen"
      charset="utf-8"
    />
    <script src="js/select.js"></script>
    <script src="js/instructions.js"></script>
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
    <!-- jQuery Modal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css"
    />
    <!-- <script type="text/javascript" src="js/db.js"></script> -->
    <!-- <script src="firebase_config.js"></script> -->
    <!-- <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>   -->
  </head>
  <body>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="/__/firebase/8.3.1/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="/__/firebase/8.3.1/firebase-auth.js"></script>
    <script src="/__/firebase/8.3.1/firebase-firestore.js"></script>
    <script src="/__/firebase/8.3.1/firebase-storage.js"></script>

    <!-- <div class="title">
            <h1 class="text-center">Tangram</h1>
        </div> -->
    <div class="left">
      <div class="instructions">
        <p id="instructions"></p>
      </div>
      <div class="image">
        <object
          id="tangramObj"
          data="assets_temp/Test.svg"
          type="image/svg+xml"
        ></object>
      </div>
    </div>
    <div class="right">
      <div class="output-outer">
        <p>Annotation:</p>
        <div class="output" id="output">
          <ol id="list"></ol>
        </div>
      </div>
      <button id="next" class="button next" disabled>Next</button>
      <div class="annotation">
        <input
          id="annotate"
          class="textbox"
          type="text"
          onkeyup="stoppedTyping()"
          disabled
        />
        <button id="submit" class="button submit" disabled>Submit</button>
        <button id="duplicate" class="button duplicate">Duplicate</button>
      </div>
    </div>

    <script>
      document.getElementById("instructions").innerHTML = instructions;
    </script>

    <script>
      function stoppedTyping() {
        var text = document.getElementById("annotate");
        var bt = document.getElementById("submit");
        var dup = document.getElementById("duplicate");
        if (text.value.length === 0 || selection.every((v) => v === false)) {
          // empty input or no selection
          bt.disabled = true;
          dup.disabled = true;
          bt.setAttribute("class", "button submit");
          bt.innerText = "Submit";
          dup.setAttribute("style", "visibility: hidden");
        } else {
          bt.disabled = false;
          dup.disabled = false;
          //duplicate
          if (ann_to_idx[text.value]) {
            bt.setAttribute("class", "button add");
            bt.innerText = "Add to Group";
            // dup.setAttribute("style", "visibility: visible");
          } else {
            //new annotation
            bt.setAttribute("class", "button submit");
            bt.innerText = "Submit";
            dup.setAttribute("style", "visibility: hidden");
          }
        }
      }

      // remove annotation
      function remove(ann, id) {
        var list = document.getElementById("list");
        var item = document.getElementById(id);
        list.removeChild(item);
        //lookup id(annotation) to pieces
        const pieces = ann_to_idx[ann];
        for (var i = 0; i < pieces.length; i++) {
          //remove piece annotation
          const piece_id = pieces[i];
          annotated[piece_id] = "";
          var a = document.getElementById("tangramObj");
          var svgDoc = a.contentDocument;
          var t = svgDoc.getElementById(piece_id);
          // t.setAttribute("fill-opacity", "0.4");
          // t.setAttribute("fill", colors[piece_id]);
          // t.setAttribute("stroke", "white");
          t.setAttribute("fill", "gray");
          // reset tracker data
          piece_to_color[piece_id] = "";
        }
        //delete ann_to_idx entry
        delete ann_to_idx[ann];
        // set final to false in log
        metadata[id]["final"] = false;

        // disable next
        var next = document.getElementById("next");
        next.disabled = true;

        logging();
      }
    </script>

    <!-- Firebase -->
    <script>
      var firebaseConfig = {
        apiKey: "AIzaSyDVFNgeaaWeBSNdAXoieOHmeoEcMnST6Xc",
        authDomain: "tangram-c997f.firebaseapp.com",
        projectId: "tangram-c997f",
        storageBucket: "tangram-c997f.appspot.com",
        messagingSenderId: "828079104765",
        appId: "1:828079104765:web:d8c5928395240394e0d494",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const storage = firebase.storage();
      var storageRef = storage.ref();

      //download SVG
      function GetElementInsideContainer(containerID, childID) {
        var elm = document.getElementById(childID);
        var parent = elm ? elm.parentNode : {};
        return parent.id && parent.id === containerID ? elm : {};
      }

      function download() {
        var svgData = GetElementInsideContainer("graph", "SvgjsSvg1000")
          .outerHTML;

        var svgBlob = new Blob([svgData], {
          type: "image/svg+xml;charset=utf-8",
        });
        // var svgUrl = URL.createObjectURL(svgBlob);
        // var downloadLink = document.createElement("a");
        // downloadLink.href = svgUrl;
        // downloadLink.download = "test.svg";
        // // document.body.appendChild(downloadLink);
        // downloadLink.click();
        // // document.body.removeChild(downloadLink);

        return svgBlob;
      }

      function submit() {
        var blob = download();

        var ref = storageRef.child("svgs/test.svg");

        ref.put(blob).then((snapshot) => {
          console.log("Uploaded a blob or file!");
          snapshot.ref.getDownloadURL().then((url) => {
            db.collection("svgs")
              .add({
                name: "placeholder",
                link: url,
              })
              .then((docRef) => {
                console.log("Document written with ID: ", docRef.id);
              })
              .catch((error) => {
                console.error("Error adding document: ", error);
              });
          });
        });
      }
      document.getElementById("submit").addEventListener("click", submit());
    </script>

    <!-- <div class="sidebar">
            <div class="sidebar-item" onclick="showTutorial()">
                <span class="octicon octicon-question"></span>
            </div>
            <div class="sidebar-item">
                <a href="https://github.com/IonicaBizau/tangram" target="blank">
                    <span class="octicon octicon-octoface"></span>
                </a>
            </div>
            <div class="sidebar-item">
                <a href="https://www.google.ro/search?q=tangram+ideas&tbm=isch" target="blank">
                    <span class="octicon octicon-light-bulb"></span>
                </a>
            </div>
        </div> -->
  </body>
</html>
